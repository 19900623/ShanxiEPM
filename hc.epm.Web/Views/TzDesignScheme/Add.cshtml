@using hc.epm.Common;
@using hc.Plat.Common.Extend;
@model hc.epm.DataModel.Business.Epm_TzDesignScheme
@{
    ViewBag.Title = "设计方案";
}

<link href="~/Resource/css/ProjectManagement.css" rel="stylesheet" />

<style>
    .btn-pro {
        width: 15%;
        height: 35px;
        border: none;
        background-color: #c3c3c3 !important;
        color: white;
        border-radius: 4px;
        font-size: 16px;
    }
</style>
<div class="contentData">
    <form class="form-horizontal" id="mainForm">
        <div class="row">
            <div class="module-div">
                <h4>  项目基础信息</h4>
                <table class="datalist" style="word-break:break-all;word-wrap:break-word;margin-top:10px;margin-bottom:10px;">
                    <tbody>
                        <tr>
                            <td class="table_title">项目名称:</td>
                            <td class="td-div" colspan="3">
                                <div>@Model.ProjectName</div>
                                <input type="hidden" id="ProjectId" name="ProjectId" value="@Model.ProjectId" />
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title">站库名称:</td>
                            <td class="td-div">
                                <div>@Model.StationName</div>
                            </td>
                            <td class="table_title">项目性质:</td>
                            <td class="td-div">
                                <div>@Model.Nature</div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title">项目类型：</td>
                            <td class="td-div">
                                <div>@Model.ProjectType </div>
                            </td>
                            <td class="table_title">项目编号：</td>
                            <td class="td-div">
                                <div>@Model.ProjectCode</div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title">地区公司：</td>
                            <td class="td-div">
                                <div>@Model.RegionCompany  </div>
                            </td>
                            <td class="table_title">地市公司：</td>
                            <td class="td-div">
                                <div>@Model.CompanyName </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title">估算投资：</td>
                            <td class="td-div">
                                <div>@Model.PredictMoney </div>
                            </td>
                            <td class="table_title">工程费用：</td>
                            <td class="td-div">
                                <div>@Model.EngineeringCost </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title">土地费用：</td>
                            <td class="td-div">
                                <div>@Model.LandCosts </div>
                            </td>
                            <td class="table_title">其他费用：</td>
                            <td class="td-div">
                                <div>@Model.OtherExpenses  </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="module-div">
                <h4>初设信息</h4>
                <table class="datalist" style="word-break:break-all;word-wrap:break-word;margin-top:10px;">
                    <tbody>
                        <tr>
                            <td class="table_title"><i class="color_red">*</i> 初步设计单位:</td>
                            <td class="td-div">
                                <input id="DesignUnit" type="text" name="DesignUnit" class="form-control " placeholder="" value="@Model.DesignUnit" />
                            </td>
                            <td class="table_title"><i class="color_red">*</i> 示范/标注:</td>
                            <td class="td-div">
                                @*<select class="form-control">
                                    <option value="value">标准加油站（油库）</option>
                                </select>*@
                                <input id="StandarCode" type="text" name="StandarCode" class="form-control " placeholder="" value="@Model.StandarCode" />
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title"><i class="color_red">*</i> 上报概算:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" nane="Estimate" value="@(Model.Estimate.ToString("0.00"))"/> 万元</div>
                            </td>
                            <td class="table_title"><i class="color_red">*</i> 工程费用:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" name="EngineeringCost" value="@(Model.EngineeringCost.ToString("0.00"))"/> 万元</div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title"><i class="color_red">*</i> 工程其他费用：</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" name="OtheInvestment" value="@(Model.OtheInvestment.ToString("0.00"))"/> 万元</div>
                            </td>
                            <td class="table_title"><i class="color_red">*</i> 设计单位招标时间：</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" type="date" name="InviteTime"/> </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title">设计单位负责人：</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; " name="DesignUnitCharge" value="@Model.DesignUnitCharge"/> </div>
                            </td>
                            <td class="table_title">职务：</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px;" name="DesignJob" value="@Model.DesignJob"/> </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title">项目经理：</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; " name="ProjectManager" value="@Model.ProjectManager"/> </div>
                            </td>
                            <td class="table_title">职务：</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; " name="ProjectJob" value="@Model.ProjectJob"/> </div>
                            </td>
                        </tr>

                    </tbody>
                </table>
            </div>
            <div class="module-div">
                <h4>主要工程内容</h4>
                <table class="datalist" style="word-break:break-all;word-wrap:break-word;margin-top:10px;">
                    <tbody>
                        <tr>
                            <td class="table_title"><i class="color_red">*</i> 占地面积:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" name="LandArea" value="@Model.LandArea"/> 平米 </div>
                            </td>
                            <td class="table_title"><i class="color_red">*</i> 加油机:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" name="MachineofOilStage" value="@(Model.MachineofOilStage.ToString("0.00"))" /> 台</div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title"><i class="color_red">*</i> 加气机:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" name="MachineofGasStage" value="@(Model.MachineofGasStage.ToString("0.00"))"/> 台 </div>
                            </td>
                            <td class="table_title"><i class="color_red">*</i> 储气机:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" name="GasWells" value="@(Model.GasWells.ToString("0.00"))"/> 方</div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title"><i class="color_red">*</i> 罐容:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" name="OilTank" value="@(Model.OilTank.ToString("0.00"))"/> 方 </div>
                            </td>
                            <td class="table_title"> 罩棚面积:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" name="Shelter" value="@Model.Shelter"/> 平米</div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title"> 站房面积:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" name="StationRoom" value="@Model.StationRoom"/> 平米 </div>
                            </td>
                            <td class="table_title"> 便利店面积:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px; width:83%" name="ConvenienceRoom" value="@Model.ConvenienceRoom"/> 平米</div>
                            </td>
                        </tr>
                    </tbody>

                </table>
            </div>
            <div class="module-div">
                <h4>其他信息</h4>
                <table class="datalist" style="word-break:break-all;word-wrap:break-word;margin-top:10px;">
                    <tbody>
                        <tr>
                            <td class="table_title"><i class="color_red">*</i> 批复概算投资:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px;" name="ReleaseInvestmentAmount" value="@Model.ReleaseInvestmentAmount"/></div>
                            </td>
                            <td class="table_title"><i class="color_red">*</i> 批复文号:</td>
                            <td class="td-div">
                                <div><input class="td-div form-control  input_unit" style="font-size:14px; height:30px;padding:3px 5px;" name="ApprovalNo" value="@Model.ApprovalNo"/> </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="table_title"> 其他工程内容:</td>
                            <td class="td-div" colspan="3">
                                <textarea placeholder="请输入其他内容" rows="3" cols="150" name="OtherProject">@Model.OtherProject</textarea>
                            </td>

                        </tr>
                        <tr>
                            <td class="table_title"><i class="color_red">*</i>  项目信息是否与实际同步:</td>
                            <td class="td-div" colspan="3">
                                @*<input type="radio" name="IsSynchro" value=" " checked /> 是&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="IsSynchro" value=" " /> 否*@
                                @foreach (var item in ViewBag.IsSynchro)
                                {
                                    if (Model.IsSynchro != null)
                                    {
                                        if (Model.IsSynchro == item.No)
                                        {
                                            <label class="radio-inline">
                                                <input type="radio" name="IsSynchro" data-code="IsSynchro" autocomplete="off" value="@item.No" checked>@item.Name
                                            </label>
                                        }
                                        else
                                        {
                                            <label class="radio-inline">
                                                <input type="radio" name="IsSynchro" data-code="IsSynchro" autocomplete="off" value="@item.No">@item.Name
                                            </label>
                                        }
                                    }
                                }
                            </td>

                        </tr>
                </table>
            </div>
            <div class="module-div">
                <h4>附件信息</h4>
                <table class="datalist" style="word-break:break-all;word-wrap:break-word;margin-top:10px;">
                    <tbody>
                        <tr>
                            <td class="table_title"> 附件类型:</td>
                            <td class="td-div">                                
                                @Html.Raw(Html.DropDownList("FileType", ViewBag.AnnexType as SelectList, null, new { @class = "form-control sel" }))
                            </td>
                            <td class="table_title" style="text-align:left;">
                                <div class="btn-upload">
                                    <input type="button" id="btnUploadFile1" class="btnUploadFile btn  form-control" style="position: relative; z-index: 1;width: 100px;font-size: 16px;" value="选择附件" />
                                    <span style="vertical-align:bottom; margin-left:15px; color:#B7B7B7;"></span>
                                </div>
                            </td>
                            <td class="td-div"><div class="color_red text_lf"> 附件类型仅支持：doc,pdf,excel,ppt,png等</div></td>
                        </tr>
                        <tr class="headtr">
                            <th class="table_title" style="width: 219px;">序号</th>
                            <th class="td-div">附件名称</th>
                            <th class="table_title">附件类型</th>
                            <th class="td-div">操作</th>
                        </tr>
                        
                        @if (Model.TzAttachs != null && Model.TzAttachs.Count() > 0)
                        {
                            foreach (var item in Model.TzAttachs)
                            {

                                <tr id="${obj.GuidId}">
                                    <td><span class="font-black">@item.Sort</span></td>
                                    <td class="text_lf td-div"><span class="font-black">@item.Name</span></td>
                                    <td><span class="font-black">@item.TypeName</span></td>
                                    <td class="td-div" style="text-align:center">
                                        <a class="fileDel" href="javascript:void(0)" style="color:#337ab7;">删除</a>
                                        <input type="hidden" id="updata" data-id="@item.Id" data-url="@item.FilePath" data-src="@item.FilePath" data-name="@item.Name" data-size="@item.Size" data-time="@(Convert.ToDateTime(item.CreateTime).ToString("yyyy-MM-dd"))" data-typeno="@item.TypeNo" data-typename="@item.TypeName">
                                    </td>
                                </tr>
                            }
                        }
                </table>
            </div>
            <div class="layui-form-item  btn-save" style="margin-top:60px;text-align:center;">
                <input type="button" id="save1" lay-submit lay-filter="sub" value="暂&nbsp;&nbsp;&nbsp;存" class="layui-btn layui-btn-big save" data-state="@(PreProjectApprovalState.WaitSubmitted.GetValue().ToString())" />
                <input type="button" id="save" lay-submit lay-filter="sub" value="提&nbsp;&nbsp;&nbsp;交" class="layui-btn layui-btn-big save" data-state="@(PreProjectApprovalState.WaitApproval.GetValue().ToString())" />
                <input type="button" id="close" value="取&nbsp;&nbsp;&nbsp;消" class="layui-btn layui-btn-big" />
            </div>
        </div>
        <input type="file" id="loadObj" name="loadObj" style="display:none!important" onchange="uploadOpj()">

        <input type="file" id="loadFile1" name="loadFile1" style="display:none!important" onchange="uploadFile1()">
        <!--附件数据-->
        <input type="hidden" name="fileDataJsonFile" id="fileDataJsonFile" />
        <!--状态数据-->
        <input type="hidden" name="State" id="State" />
    </form>
</div>
<script>
    $('#btnUploadFile1').click(function () {
        $("#loadFile").attr("fileListId", $(this).attr("name"));
        document.getElementById("loadFile1").click();
    });


    //上传附件
    function uploadFile1() {
       var fileObj = document.getElementById("loadFile1").files[0]; // js 获取文件对象
        var formFile = new FormData();
       formFile.append("file", fileObj);
       var path = formFile;
        $.ajax({
            url: "/Upload/UploadHB",
            type: "POST",
            data: path,
            contentType: false,
            processData: false,
            success: function (data) {
                for (var i = 0; i < data.length; i++) {
                    var obj = {};
                    obj.Name = data[i].Name;
                    obj.GuidId = data[i].GuidId;
                    obj.Size = data[i].Size;
                    obj.ImageType = data[i].ImageType;
                    obj.Group = data[i].ResponseObject.FDFS_GROUP;
                    obj.Url = data[i].ResponseObject.FDFS_NAME;
                    obj.TypeNo = $("#fileType").find("option:selected").val();
                    obj.TypeName = $("#fileType").find("option:selected").text()

                    if (data[i].ImageType == null) {
                        var imgUrl = getFileImg(obj.Name);
                        //附件排序判断
                        var sort;
                        sort = $('.fileShow-append').find('tr:last-child').find('.sort').text();
                        if (sort == "") {
                            sort = 0;
                            sort++;
                        } else {
                            sort++;
                        }
                        var odiv = `
                                     <tr>
                                        <td><span class ="font-black sort">${sort}</span></td>
                                        <td class ="text_lf td-div"><span class ="font-black">${obj.Name}</span></td>
                                        <td><span class ="font-black">${obj.TypeName}</span></td>
                                        <td class ="td-div" style="text-align:center">
                                        <a href="javascript:void(0)" style="color:#337ab7;" class ="fileDel">删除</a>
                                        <input type="hidden" id="updata" data-id="${obj.GuidId}" data-url="${obj.Url}" data-src="${imgUrl}" data-name="${obj.Name}" data-size="${obj.Size}" data-upname="${data[i].UploadName}" data-time="${new Date(formatDateByJson(data[i].UploadDate)).Format("yyyy-MM-dd")}" data-group="${obj.Group}" data-typename="${obj.TypeName}" data-typeno="${obj.TypeNo}">
                                        </td>
                                    </tr>
                           `
                        $('.fileShow-append').append(odiv);
                    }
                }

            }
        });
    }



    //获取项目
    $(".btn-pro").click(function(){
        layer.open({
            type:2,
            title: "选择项目",
            area: ['950px', '500px'],
            btn: ["确定", "返回"],
            //scrollbar:"false",
            btnAlign: 'c',
            content: "/Comm/SelectProjectAll?companyId=@ViewBag.UnitID",
        });
    })

    layui.use(['layer', 'form', 'element', 'laypage'], function () {
        var layer = layui.layer, form = layui.form, element = layui.element, $ = layui.jquery, laypage = layui.laypage;

        //数据提交
        $(".save").click(function () {
            var fileDataArray = [];
            $(".fileShow-append tr:not(.headtr)").each(function (index, item) {
                fileDataArray.push({
                    Name: $(item).find("#updata").data("name"),
                    GuidId: $(item).find("#updata").data("id"),
                    Size: $(item).find("#updata").data("size"),
                    Group: $(item).find("#updata").data("group"),
                    FilePath: $(item).find("#updata").data("url"),
                    TypeNo: $(item).find("#updata").data("typeno"),
                    TypeName: $(item).find("#updata").data("typename"),
                    Sort: $(item).find(".sort").text()
                })
            });
            var fileDataJson = JSON.stringify(fileDataArray);
            $("#fileDataJsonFile").val(fileDataJson);
           // console.log(fileDataArray)
            $("#State").val($(this).data("state"))//提交或保存的状态值
            //对表单进行验证
            var bv = $('#mainForm').data('bootstrapValidator');
            bv.validate();
            var search = $("form").serialize();
            if (bv.isValid()) {
            $.post("Add", search, function (data) {
                    if (data.Flag) {
                        layer.msg("操作成功", { time: 1000, icon: 1 }, function () {
                            window.location.href = "/TzDesignScheme/Index";
                        });
                    } else {
                        layer.alert(data.Message, { icon: 2 });
                    }
                });
            }
        });
    });

    //表单验证
    $('#mainForm').bootstrapValidator({
        excluded: [':hidden'],//[':disabled', ':hidden', ':not(:visible)'] //设置隐藏组件可验证
        InviteTime: {
            InvestResearchUserName: {
                validators: {
                    notEmpty: {
                        message: '设计单位招标时间不能为空'
                    }
                }
            },
            LandArea: {
                validators: {
                    notempty: {
                        message: '占地面积不能为空'
                    }
                }
            },
            ReleaseInvestmentAmount: {
                validators: {
                    notempty: {
                        message: '批复概算投资不能为空'
                    }
                }
            },
            ApprovalNo: {
                validators: {
                    notempty: {
                        message: '批复文号不能为空'
                    }
                }
            },
            MachineofOilStage: {
                validators: {
                    notempty: {
                        message: '加油机不能为空'
                    },
                    regexp: {
                        regexp: /^\d+(\.\d{0,2})?$/,
                        message: "加油机格式输入错误"
                    },
                }
            },
            MachineofGasStage: {
                validators: {
                    notempty: {
                        message: '加气机不能为空'
                    },
                    regexp: {
                        regexp: /^\d+(\.\d{0,2})?$/,
                        message: "加气机格式输入错误"
                    },
                }
            },
            GasWells: {
                validators: {
                    notempty: {
                        message: '储气机不能为空'
                    },
                    regexp: {
                        regexp: /^\d+(\.\d{0,2})?$/,
                        message: "储气机格式输入错误"
                    },
                }
            },
            OilTank: {
                validators: {
                    notempty: {
                        message: '罐容不能为空'
                    },
                    regexp: {
                        regexp: /^\d+(\.\d{0,2})?$/,
                        message: "罐容格式输入错误"
                    },
                }
            },
            Estimate: {
                validators: {
                    regexp: {
                        regexp: /^\d+(\.\d{0,2})?$/,
                        message: "上报概算格式输入错误"
                    },
                    notempty: {
                        message: '上报概算不能为空'
                    },
                }
            },
            TotalInvestment: {
                validators: {
                    regexp: {
                        regexp: /^\d+(\.\d{0,2})?$/,
                        message: "工程费用格式输入错误"
                    },
                    notempty: {
                        message: '工程费用不能为空'
                    },
                }
            },
            OtheInvestment: {
                validators: {
                    regexp: {
                        regexp: /^\d+(\.\d{0,2})?$/,
                        message: "工程其他费用格式输入错误"
                    },
                    notempty: {
                        message: '工程其他费用不能为空'
                    },
                },
            },
        },
    });
    //返回
    $("#close").click(function () {
        window.location.href = "/TzDesignScheme/Index";
    });

    //删除附件
    $("body").on('click', '.fileDel', function () {
        $(this).parents("tr").remove();
        $(".fileShow-append tr:not(.headtr)").each(function (index) {
            $(this).find(".sort").text(index + 1);//重新赋值附件排序
        });
    });
</script>

